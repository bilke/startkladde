#include "SchemaDumper.h"

#include <iostream>

#include <QFile>
#include <QDateTime>
#include <QStringList>

#include "src/db/interface/Interface.h"
#include "src/db/migration/Migrator.h" // Required for migrationsTableName/migrationsColumnName
#include "src/db/result/Result.h"
#include "src/text.h"

SchemaDumper::SchemaDumper (Interface &interface):
	interface (interface)
{
}

SchemaDumper::~SchemaDumper ()
{
}

QString SchemaDumper::dumpSchema ()
{
	QStringList output;

	output << "---";

	dumpTables (output);
	dumpVersions (output);

	return output.join ("\n");
}

void SchemaDumper::dumpSchemaToFile (const QString &filename)
{
	QString dump=dumpSchema ();

	QFile file (filename);
	try
	{
		file.open (QFile::WriteOnly);

		QString generatedDate=QDateTime::currentDateTime ().toUTC ().toString (Qt::ISODate);
		file.write (("# This file has been autogenerated by SchemaDumper on " + generatedDate +" UTC.\n").toUtf8 ());
		file.write ("# It should not be modified as any changes will be overwritten.\n");
		file.write ("#\n");
		file.write ("# This file should be checked into version control. See the developer\n");
		file.write ("# documentation (doc/internal/database.txt) for further information.\n");

		file.write (dump.toUtf8 ());
		file.write ("\n");
		file.close ();
	}
	catch (...)
	{
		file.close ();
		throw;
	}
}

void SchemaDumper::dumpTables (QStringList &output)
{
	output << "tables:";

	QSharedPointer<Result> result=interface.executeQueryResult ("SHOW TABLES");

	while (result->next ())
		dumpTable (output, result->value (0).toString ());
}

void SchemaDumper::dumpTable (QStringList &output, const QString &name)
{
	// Don't dump the migrations table
	if (name==Migrator::migrationsTableName) return;

	output << QString ("- name: \"%1\"").arg (name);
	dumpColumns (output, name);
	dumpIndexes (output, name);
}
void SchemaDumper::dumpColumns (QStringList &output, const QString &table)
{
	output << "  columns:";

	Query query=Query ("SHOW FULL COLUMNS FROM %1").arg (table);
	QSharedPointer<Result> result=interface.executeQueryResult (query);

	QSqlRecord record=result->record ();
	// TODO: handle index not found. Also, this is backend specific and should be in Interface
	int nameIndex=record.indexOf ("Field");
	int typeIndex=record.indexOf ("Type");
	int nullIndex=record.indexOf ("Null");
	int keyIndex=record.indexOf ("Key");
	int extraIndex=record.indexOf ("Extra");

	while (result->next ())
	{
		QString name=result->value (nameIndex).toString ();
		QString type=result->value (typeIndex).toString ();
		QString null=result->value (nullIndex).toString ();
		QString key=result->value (keyIndex).toString ();
		QString extra=result->value (extraIndex).toString ();

		dumpColumn (output, name, type, null, key, extra);
	}
}

void SchemaDumper::dumpColumn (QStringList &output, const QString &name, const QString &type, const QString &null, const QString &key, const QString &extra)
{
	output << QString ("  - name: \"%1\"").arg (name);
	output << QString ("    type: \"%1\"").arg (type);
	output << QString ("    nullok: \"%1\"").arg (null);
	if (key=="PRI")
		output << QString ("    primary_key: true");
	if (!blank (extra))
		output << QString ("    extra: \"%1\"").arg (extra);
}

void SchemaDumper::dumpIndexes (QStringList &output, const QString &table)
{
	QList<IndexSpec> indexes=interface.showIndexes (table);

	// Don't output anything if there are no indexes
	if (indexes.isEmpty ()) return;

	output << "  indexes:";
	foreach (const IndexSpec &index, indexes)
		dumpIndex (output, index);
}

void SchemaDumper::dumpIndex (QStringList &output, const IndexSpec &index)
{
	output << QString ("  - name: \"%1\"").arg (index.getName ());
	output << QString ("    columns: \"%1\"").arg (index.getColumns ());
}

void SchemaDumper::dumpVersions (QStringList &output)
{
	// TODO handle empty/nonexistant migrations table
	output << "versions:";

	QString table=Migrator::migrationsTableName;
	QString column=Migrator::migrationsColumnName;

	Query query=Query::selectDistinctColumns (table, column);
	QSharedPointer<Result> result=interface.executeQueryResult (query);

	while (result->next ())
		output << QString ("- %1").arg (result->value (0).toString ());
}
